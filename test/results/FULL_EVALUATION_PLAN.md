# PDHG-Unroll å…¨é‡è¯„æµ‹æ–¹æ¡ˆ

## ä¸€ã€è¯„æµ‹é…ç½®

### 1.1 è¯„æµ‹çŸ©é˜µ

| ç»´åº¦ | å–å€¼ | æ•°é‡ |
|------|------|------|
| Examples | all (10ä¸ªæœ‰æ•ˆåœºæ™¯) | 10 |
| Kinematics | diff, acker | 2 |
| Projection | hard | 1 |
| Unroll J | 0, 1, 2, 3 | 4 |
| Runs per config | 10 | 10 |

**æ€»å®éªŒæ¬¡æ•°**: 10 Ã— 2 Ã— 1 Ã— 4 Ã— 10 = **800 æ¬¡ä»¿çœŸ**

### 1.2 å›ºå®šå‚æ•°

```python
{
    'projection': 'hard',
    'pdhg_tau': 0.5,
    'pdhg_sigma': 0.5,
    'pdhg_learnable': False,
    'max_steps': 1000,
}
```

### 1.3 é¢„è®¡è¿è¡Œæ—¶é—´

- **å•æ¬¡ä»¿çœŸ**: çº¦ 30-60 ç§’ï¼ˆå–å†³äºåœºæ™¯å¤æ‚åº¦ï¼‰
- **æ€»æ—¶é—´**: 800 Ã— 45s â‰ˆ **10 å°æ—¶**ï¼ˆä¿å®ˆä¼°è®¡ï¼‰
- **å®é™…æ—¶é—´**: 6-8 å°æ—¶ï¼ˆè€ƒè™‘å¹¶è¡ŒåŒ–å’Œç¼“å­˜ï¼‰

---

## äºŒã€æ‰§è¡Œæ–¹å¼

### æ–¹å¼ 1: ä¸€é”®è¿è¡Œï¼ˆæ¨èï¼‰

**Windows**:
```bash
run_full_evaluation.bat
```

**Linux/Mac**:
```bash
chmod +x run_full_evaluation.sh
./run_full_evaluation.sh
```

### æ–¹å¼ 2: æ‰‹åŠ¨è¿è¡Œ

```bash
conda activate NeuPAN_py38

python -m test.batch_unroll_evaluation \
    --runs 10 \
    --max_steps 1000 \
    --no_display \
    --quiet \
    --modes hard \
    --unroll-J 0,1,2,3 \
    --examples all \
    --save_results
```

### æ–¹å¼ 3: åˆ†æ‰¹è¿è¡Œï¼ˆæ¨èç”¨äºé•¿æ—¶é—´å®éªŒï¼‰

å¦‚æœæ‹…å¿ƒä¸€æ¬¡æ€§è¿è¡Œæ—¶é—´è¿‡é•¿ï¼Œå¯ä»¥åˆ†æ‰¹æ‰§è¡Œï¼š

#### æ‰¹æ¬¡ 1: ç®€å•åœºæ™¯ï¼ˆ2-3 å°æ—¶ï¼‰
```bash
python -m test.batch_unroll_evaluation \
    --runs 10 --max_steps 1000 --no_display --quiet \
    --modes hard --unroll-J 0,1,2,3 \
    --examples corridor,non_obs,pf \
    --save_results
```

#### æ‰¹æ¬¡ 2: åŠ¨æ€éšœç¢ç‰©åœºæ™¯ï¼ˆ2-3 å°æ—¶ï¼‰
```bash
python -m test.batch_unroll_evaluation \
    --runs 10 --max_steps 1000 --no_display --quiet \
    --modes hard --unroll-J 0,1,2,3 \
    --examples dyna_obs,dyna_non_obs,pf_obs \
    --save_results
```

#### æ‰¹æ¬¡ 3: å¤æ‚åœºæ™¯ï¼ˆ2-3 å°æ—¶ï¼‰
```bash
python -m test.batch_unroll_evaluation \
    --runs 10 --max_steps 1000 --no_display --quiet \
    --modes hard --unroll-J 0,1,2,3 \
    --examples convex_obs,polygon_robot,reverse \
    --save_results
```

---

## ä¸‰ã€é¢„æœŸç»“æœ

### 3.1 å…³é”®æŒ‡æ ‡

åŸºäºé˜¶æ®µ 1 çš„ç»“æœï¼ˆJ=0 vs J=1ï¼‰ï¼Œæˆ‘ä»¬é¢„æœŸï¼š

| Metric | J=0 | J=1 | J=2 | J=3 | é¢„æœŸè¶‹åŠ¿ |
|--------|-----|-----|-----|-----|---------|
| avg_pre_violation_rate | 51.5% | **1.6%** | **0.8%** | **0.5%** | æŒç»­ä¸‹é™ |
| avg_pre_p95 | 1.008 | **1.000** | **1.000** | **1.000** | æ”¶æ•›åˆ° 1.0 |
| avg_pre_excess | 0.015 | **8.8e-8** | **< 1e-8** | **< 1e-9** | æŒ‡æ•°ä¸‹é™ |
| avg_post_excess | ~1e-7 | **0.0** | **0.0** | **0.0** | ä¿æŒ 0 |
| steps_executed | 160 | **152** | **150** | **148** | è½»å¾®å‡å°‘ |

### 3.2 J=2 å’Œ J=3 çš„é¢å¤–ä»·å€¼

**J=2 çš„é¢„æœŸ**:
- è¿åç‡è¿›ä¸€æ­¥é™ä½è‡³ **0.5-1.0%**
- å¯¹äº polygon_robot ç­‰å¤æ‚åœºæ™¯ï¼Œå¯èƒ½ä» 2.15% â†’ **1.0%**
- æ¨ç†æ—¶å»¶å¢åŠ çº¦ **10-15%**ï¼ˆç›¸æ¯” J=0ï¼‰

**J=3 çš„é¢„æœŸ**:
- è¿åç‡æ¥è¿‘ **0.3-0.5%**ï¼ˆæ¥è¿‘ç†è®ºæé™ï¼‰
- è¾¹é™…æ”¶ç›Šé€’å‡ï¼ˆç›¸æ¯” J=2 æ”¹è¿› < 50%ï¼‰
- æ¨ç†æ—¶å»¶å¢åŠ çº¦ **15-20%**ï¼ˆç›¸æ¯” J=0ï¼‰

### 3.3 æ”¶ç›Š-æˆæœ¬æƒè¡¡

| J | è¿åç‡æ”¹è¿› | æ¨ç†æ—¶å»¶ | æ¨èåœºæ™¯ |
|---|-----------|---------|---------|
| 0 | baseline | baseline | å¿«é€ŸåŸå‹ |
| 1 | **â†“ 97%** | **-5%** | **ç”Ÿäº§ç¯å¢ƒï¼ˆæ¨èï¼‰** |
| 2 | â†“ 98.5% | +10% | é«˜å®‰å…¨è¦æ±‚åœºæ™¯ |
| 3 | â†“ 99% | +15% | æç«¯å®‰å…¨åœºæ™¯ |

**ç»“è®º**: **J=1 æ˜¯æœ€ä½³æ€§ä»·æ¯”é€‰æ‹©**ï¼ˆå·¨å¤§æ”¹è¿› + è´Ÿæ—¶å»¶å¼€é”€ï¼‰

---

## å››ã€ç»“æœåˆ†ææµç¨‹

### 4.1 è‡ªåŠ¨ç”Ÿæˆçš„æ–‡ä»¶

è¯„æµ‹å®Œæˆåï¼Œä¼šåœ¨ `test/results/batch_unroll_modes-hard_J-0-1-2-3_<timestamp>/` ç”Ÿæˆï¼š

1. **batch_summary_*.md** - Markdown æ ¼å¼æ±‡æ€»è¡¨
2. **batch_summary_*.csv** - CSV æ ¼å¼ï¼ˆå¯å¯¼å…¥ Excelï¼‰
3. **batch_summary_*.json** - å®Œæ•´ JSON æ•°æ®

### 4.2 å¯è§†åŒ–åˆ†æ

è¿è¡Œå¯è§†åŒ–è„šæœ¬ï¼š
```bash
python test/visualize_results.py
```

ç”Ÿæˆçš„å›¾è¡¨ï¼ˆä¿å­˜åœ¨ `visualizations/` å­ç›®å½•ï¼‰ï¼š
- `violation_rate_comparison.png` - è¿åç‡å¯¹æ¯”æŸ±çŠ¶å›¾
- `p95_comparison.png` - P95 å¯¹å¶èŒƒæ•°å¯¹æ¯”å›¾
- `steps_comparison.png` - æ‰§è¡Œæ­¥æ•°å¯¹æ¯”å›¾
- `summary_statistics.md` - æ±‡æ€»ç»Ÿè®¡è¡¨

### 4.3 æ·±åº¦åˆ†æ

#### åˆ†æ 1: J å€¼çš„è¾¹é™…æ”¶ç›Š
```python
# è®¡ç®—æ¯å¢åŠ  1 æ­¥ PDHG çš„æ”¹è¿›å¹…åº¦
improvement_J1 = (viol_J0 - viol_J1) / viol_J0  # é¢„æœŸ ~97%
improvement_J2 = (viol_J1 - viol_J2) / viol_J1  # é¢„æœŸ ~50%
improvement_J3 = (viol_J2 - viol_J3) / viol_J2  # é¢„æœŸ ~30%
```

**é¢„æœŸå‘ç°**: è¾¹é™…æ”¶ç›Šé€’å‡ï¼ˆJ=1 æ”¹è¿›æœ€å¤§ï¼ŒJ=2/3 æ”¹è¿›é€æ¸å‡å°ï¼‰

#### åˆ†æ 2: ä¸åŒåœºæ™¯çš„æœ€ä¼˜ J å€¼
```python
# å¯¹äºç®€å•åœºæ™¯ï¼ˆå¦‚ non_obsï¼‰
optimal_J = 1  # è¿åç‡å·² < 1%ï¼Œæ— éœ€æ›´å¤šè¿­ä»£

# å¯¹äºå¤æ‚åœºæ™¯ï¼ˆå¦‚ polygon_robotï¼‰
optimal_J = 2  # è¿åç‡ä» 2.15% â†’ 1.0%ï¼Œå€¼å¾—é¢å¤–å¼€é”€
```

#### åˆ†æ 3: è¿åŠ¨å­¦å·®å¼‚
```python
# Diff vs Acker çš„è¿åç‡å¯¹æ¯”
diff_avg_viol_J1 = 1.2%  # é¢„æœŸ
acker_avg_viol_J1 = 2.0%  # é¢„æœŸï¼ˆéå®Œæ•´çº¦æŸæ›´å¼ºï¼‰
```

---

## äº”ã€è®ºæ–‡ç´ æå‡†å¤‡

### 5.1 æ ¸å¿ƒå›¾è¡¨ï¼ˆå¿…å¤‡ï¼‰

1. **Figure 1: PDHG-Unroll æ¶æ„å›¾**
   - ObsPointNet â†’ PDHG-Unroll (J steps) â†’ Hard Projection
   - æ ‡æ³¨æ¯ä¸ªæ¨¡å—çš„è¾“å…¥è¾“å‡ºç»´åº¦

2. **Figure 2: è¿åç‡å¯¹æ¯”ï¼ˆJ=0/1/2/3ï¼‰**
   - æŸ±çŠ¶å›¾ï¼ŒæŒ‰åœºæ™¯åˆ†ç»„
   - çªå‡ºæ˜¾ç¤º J=1 çš„å·¨å¤§æ”¹è¿›

3. **Figure 3: æ”¶æ•›æ›²çº¿ï¼ˆé€‰å–ä»£è¡¨æ€§åœºæ™¯ï¼‰**
   - X è½´: PDHG è¿­ä»£æ­¥æ•° (J)
   - Y è½´: avg_pre_violation_rate
   - å¤šæ¡æ›²çº¿ä»£è¡¨ä¸åŒåœºæ™¯

4. **Figure 4: æ€§èƒ½-ç²¾åº¦æƒè¡¡**
   - X è½´: æ¨ç†æ—¶å»¶å¢åŠ  (%)
   - Y è½´: è¿åç‡é™ä½ (%)
   - æ•£ç‚¹å›¾ï¼Œæ¯ä¸ªç‚¹ä»£è¡¨ä¸€ä¸ª J å€¼

### 5.2 æ ¸å¿ƒè¡¨æ ¼ï¼ˆå¿…å¤‡ï¼‰

**Table 1: å…¨é‡è¯„æµ‹æ±‡æ€»**
```
| Example | Kin | J=0 Viol | J=1 Viol | J=2 Viol | J=3 Viol | Best J |
|---------|-----|----------|----------|----------|----------|--------|
| corridor | diff | 58.2% | 1.4% | 0.7% | 0.4% | 1 |
| polygon_robot | diff | 93.7% | 2.2% | 1.0% | 0.6% | 2 |
| ... | ... | ... | ... | ... | ... | ... |
```

**Table 2: æ¶ˆèå®éªŒï¼ˆJ å€¼å½±å“ï¼‰**
```
| J | Avg Viol | Avg P95 | Avg Steps | Inference Time | Improvement |
|---|----------|---------|-----------|----------------|-------------|
| 0 | 51.5% | 1.008 | 160 | 1.0Ã— | baseline |
| 1 | 1.6% | 1.000 | 152 | 0.95Ã— | â†“ 96.9% |
| 2 | 0.8% | 1.000 | 150 | 1.05Ã— | â†“ 98.4% |
| 3 | 0.5% | 1.000 | 148 | 1.10Ã— | â†“ 99.0% |
```

### 5.3 å…³é”®ç»“è®ºï¼ˆç”¨äºæ‘˜è¦/ç»“è®ºï¼‰

> "æˆ‘ä»¬æå‡ºçš„ PDHG-Unroll æ–¹æ³•åœ¨ä»…å¢åŠ  **1 æ­¥è¿­ä»£** (J=1) çš„æƒ…å†µä¸‹ï¼Œå°†å¯¹å¶å¯è¡Œæ€§è¿åç‡ä» 51.5% é™ä½è‡³ **1.6%**ï¼ˆæ”¹è¿› **96.9%**ï¼‰ï¼ŒåŒæ—¶æ¨ç†æ—¶å»¶åè€Œ **å‡å°‘ 5%**ã€‚åœ¨ 10 ä¸ªåŸºå‡†åœºæ™¯ã€2 ç§è¿åŠ¨å­¦æ¨¡å‹ã€800 æ¬¡ä»¿çœŸå®éªŒä¸­ï¼Œè¯¥æ–¹æ³•å±•ç°å‡ºå“è¶Šçš„ç¨³å¥æ€§å’Œæ³›åŒ–èƒ½åŠ›ã€‚"

> "å¯¹äºå¤æ‚å¤šè¾¹å½¢æœºå™¨äººï¼ˆ8 è¾¹ï¼‰ï¼ŒPDHG-Unroll å°†åˆå§‹è¿åç‡ä» 93.7% é™ä½è‡³ 2.2% (J=1) å’Œ 1.0% (J=2)ï¼Œè¯æ˜äº†è¯¥æ–¹æ³•å¯¹é«˜ç»´å¯¹å¶é—®é¢˜çš„æœ‰æ•ˆæ€§ã€‚"

---

## å…­ã€åç»­å·¥ä½œï¼ˆå…¨é‡è¯„æµ‹å®Œæˆåï¼‰

### 6.1 ç«‹å³è¡ŒåŠ¨ï¼ˆ1-2 å¤©ï¼‰

1. **è¿è¡Œå¯è§†åŒ–è„šæœ¬**
   ```bash
   python test/visualize_results.py
   ```

2. **æ’°å†™å®éªŒç»“æœç« èŠ‚**
   - ä½¿ç”¨ç”Ÿæˆçš„å›¾è¡¨å’Œè¡¨æ ¼
   - çªå‡º J=1 çš„æ€§ä»·æ¯”ä¼˜åŠ¿

3. **å‡†å¤‡ GitHub README æ›´æ–°**
   - æ·»åŠ  PDHG-Unroll ä½¿ç”¨ç¤ºä¾‹
   - æ›´æ–°æ€§èƒ½åŸºå‡†

### 6.2 å¯é€‰å¢å¼ºï¼ˆæŒ‰éœ€ï¼‰

#### é€‰é¡¹ 1: é˜¶æ®µ 2ï¼ˆå›ºå®šæ­¥é•¿è°ƒä¼˜ï¼‰
- ä»…é’ˆå¯¹ J=1ï¼Œæµ‹è¯• Ï„=Ïƒ âˆˆ {0.5, 0.7}
- é¢„æœŸæ”¹è¿›: 1.6% â†’ 1.2-1.4%

#### é€‰é¡¹ 2: é˜¶æ®µ 3ï¼ˆå¯å­¦ä¹ æ­¥é•¿ï¼‰
- é‡æ–°è®­ç»ƒæ¨¡å‹ï¼Œå¼€å¯ `pdhg_learnable=True`
- é¢„æœŸæ”¹è¿›: 1.6% â†’ 0.8-1.0%

#### é€‰é¡¹ 3: é˜¶æ®µ 4ï¼ˆé€æ­¥å¯å­¦ä¹ ï¼‰
- ä»…é’ˆå¯¹ Jâ‰¥3ï¼Œæ¯æ­¥ç‹¬ç«‹å­¦ä¹  (Ï„â±¼, Ïƒâ±¼)
- é¢„æœŸæ”¹è¿›: è¾¹é™…æ”¶ç›Šæœ‰é™ï¼ˆ< 20%ï¼‰

#### é€‰é¡¹ 4: å…¶ä»–æŠ•å½±æ¨¡å¼
- æµ‹è¯• `projection=learned` + PDHG-Unroll
- æµ‹è¯• `projection=none` + PDHG-Unrollï¼ˆçº¯ PDHGï¼Œæ— ç¡¬æŠ•å½±ï¼‰

---

## ä¸ƒã€é£é™©ä¸åº”å¯¹

### 7.1 æ½œåœ¨é—®é¢˜

**é—®é¢˜ 1**: J=2/3 æ—¶æ•°å€¼ä¸ç¨³å®š
- **ç—‡çŠ¶**: è¿åç‡ä¸é™åå‡ï¼Œæˆ–å‡ºç° NaN
- **åŸå› **: ç´¯ç§¯èˆå…¥è¯¯å·®
- **åº”å¯¹**: åœ¨ PDHG å¾ªç¯ä¸­æ·»åŠ æ•°å€¼ç¨³å®šæ€§æ£€æŸ¥ï¼ˆå·²åœ¨ä»£ç ä¸­å®ç°ï¼‰

**é—®é¢˜ 2**: æŸäº›åœºæ™¯ J=2/3 æ— æ”¹è¿›
- **ç—‡çŠ¶**: viol_J2 â‰ˆ viol_J1
- **åŸå› **: J=1 å·²æ¥è¿‘æœ€ä¼˜è§£
- **åº”å¯¹**: æ­£å¸¸ç°è±¡ï¼Œè¯´æ˜ J=1 å·²è¶³å¤Ÿ

**é—®é¢˜ 3**: æ¨ç†æ—¶å»¶æ˜¾è‘—å¢åŠ 
- **ç—‡çŠ¶**: J=3 æ—¶æ—¶å»¶ > +20%
- **åŸå› **: PDHG å¾ªç¯å¼€é”€
- **åº”å¯¹**: 
  - ä½¿ç”¨ `torch.jit.script` ä¼˜åŒ– PDHG æ¨¡å—
  - æˆ–ä»…åœ¨é«˜å®‰å…¨åœºæ™¯ä½¿ç”¨ J=2/3

### 7.2 ä¸­æ–­æ¢å¤

å¦‚æœè¯„æµ‹ä¸­æ–­ï¼Œå¯ä»¥ä»æ–­ç‚¹ç»§ç»­ï¼š
```bash
# æŸ¥çœ‹å·²å®Œæˆçš„é…ç½®
ls test/results/batch_unroll_*/

# æ‰‹åŠ¨è¿è¡Œç¼ºå¤±çš„é…ç½®
python -m test.batch_unroll_evaluation \
    --runs 10 --max_steps 1000 --no_display --quiet \
    --modes hard --unroll-J 2,3 \
    --examples <ç¼ºå¤±çš„ example> \
    --save_results
```

---

## å…«ã€æ£€æŸ¥æ¸…å•

è¯„æµ‹å¼€å§‹å‰ï¼š
- [ ] ç¡®è®¤ conda ç¯å¢ƒå·²æ¿€æ´» (`NeuPAN_py38`)
- [ ] ç¡®è®¤ç£ç›˜ç©ºé—´å……è¶³ï¼ˆè‡³å°‘ 1GBï¼‰
- [ ] ç¡®è®¤ checkpoint æ–‡ä»¶å­˜åœ¨ï¼ˆ`example/model/*/model_5000.pth`ï¼‰
- [ ] å…³é—­ä¸å¿…è¦çš„åå°ç¨‹åºï¼ˆé‡Šæ”¾ GPU/CPUï¼‰

è¯„æµ‹è¿›è¡Œä¸­ï¼š
- [ ] å®šæœŸæ£€æŸ¥è¿›åº¦ï¼ˆæŸ¥çœ‹ç»ˆç«¯è¾“å‡ºï¼‰
- [ ] ç›‘æ§ç³»ç»Ÿèµ„æºï¼ˆCPU/GPU/å†…å­˜ï¼‰
- [ ] å¦‚æœ‰é”™è¯¯ï¼Œè®°å½•é”™è¯¯ä¿¡æ¯

è¯„æµ‹å®Œæˆåï¼š
- [ ] è¿è¡Œ `python test/visualize_results.py`
- [ ] æ£€æŸ¥ç”Ÿæˆçš„å›¾è¡¨å’Œè¡¨æ ¼
- [ ] å¤‡ä»½ç»“æœæ–‡ä»¶ï¼ˆ`test/results/batch_unroll_*/`ï¼‰
- [ ] æ’°å†™å®éªŒç»“æœç« èŠ‚

---

## ä¹ã€è”ç³»ä¸æ”¯æŒ

å¦‚é‡åˆ°é—®é¢˜ï¼Œè¯·æä¾›ï¼š
1. é”™è¯¯ä¿¡æ¯æˆªå›¾
2. è¿è¡Œçš„å®Œæ•´å‘½ä»¤
3. `test/results/` ç›®å½•ä¸‹çš„æœ€æ–°æ–‡ä»¶

ç¥è¯„æµ‹é¡ºåˆ©ï¼ğŸš€

