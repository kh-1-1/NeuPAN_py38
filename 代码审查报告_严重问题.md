# NeuPAN-py38 ä»£ç å®¡æŸ¥æŠ¥å‘Š - ä¸¥é‡é—®é¢˜

> **å®¡æŸ¥æ—¥æœŸ**: 2025-10-23  
> **å®¡æŸ¥èŒƒå›´**: æ ¸å¿ƒæ¨¡å—å®‰å…¨æ¼æ´ã€ä¸¥é‡Bugã€åŠŸèƒ½æ€§Bug  
> **ä¼˜å…ˆçº§**: ğŸ”´ é«˜ > ğŸŸ¡ ä¸­ > ğŸŸ¢ ä½

---

## ğŸ”´ ä¸¥é‡é—®é¢˜ï¼ˆé«˜ä¼˜å…ˆçº§ï¼‰

### 1. é™¤é›¶é”™è¯¯é£é™© - robot.py

**é—®é¢˜ç±»å‹**: ä¸¥é‡Bug - æ½œåœ¨å´©æºƒ  
**ä¸¥é‡ç¨‹åº¦**: ğŸ”´ é«˜  
**ä½ç½®**: `neupan/robot/robot.py:265`

**é—®é¢˜æè¿°**:
```python
B = torch.Tensor([ [cos(phi)*dt, 0], [sin(phi)*dt, 0], 
                [ tan(psi)*dt / L, v*dt/(L * (cos(psi))**2 ) ] ])
```

å½“è½¬å‘è§’ `psi` æ¥è¿‘ Â±Ï€/2 æ—¶ï¼Œ`cos(psi)` æ¥è¿‘ 0ï¼Œå¯¼è‡´ `1/(cos(psi)**2)` è¶‹å‘æ— ç©·å¤§ã€‚

**å½±å“èŒƒå›´**:
- Ackermann è½¬å‘æœºå™¨äººåœ¨å¤§è½¬å‘è§’æ—¶ä¼šå´©æºƒ
- å¯¼è‡´æ•´ä¸ªè§„åˆ’å™¨å¤±è´¥
- å¯èƒ½äº§ç”Ÿ NaN æˆ– Inf å€¼ä¼ æ’­åˆ°åç»­è®¡ç®—

**ä¿®å¤å»ºè®®**:
```python
# æ·»åŠ å®‰å…¨æ£€æŸ¥
cos_psi = cos(psi)
if abs(cos_psi) < 1e-6:  # æ¥è¿‘ Â±90 åº¦
    # ä½¿ç”¨é™åˆ¶å€¼æˆ–æŠ›å‡ºè­¦å‘Š
    cos_psi = 1e-6 if cos_psi >= 0 else -1e-6

B = torch.Tensor([ [cos(phi)*dt, 0], [sin(phi)*dt, 0], 
                [ tan(psi)*dt / L, v*dt/(L * cos_psi**2 ) ] ])
```

**ç›¸å…³ä»£ç **:
- `neupan/robot/robot.py:257-271` (linear_ackermann_model)
- `neupan/robot/robot.py:64-66` (max_speed é™åˆ¶æ£€æŸ¥)

---

### 2. æ•°ç»„è¶Šç•Œé£é™© - roi_selector.py

**é—®é¢˜ç±»å‹**: ä¸¥é‡Bug - æ½œåœ¨å´©æºƒ  
**ä¸¥é‡ç¨‹åº¦**: ğŸ”´ é«˜  
**ä½ç½®**: `neupan/blocks/roi_selector.py:160, 179`

**é—®é¢˜æè¿°**:
```python
# Line 160
ds_local = np.linspace(0, n_roi - 1, m, dtype=int)
sel_idx = sel_idx[ds_local]  # å¦‚æœ sel_idx é•¿åº¦ < max(ds_local)ï¼Œä¼šè¶Šç•Œ
```

å½“ `n_roi` å¾ˆå°ä½† `ds_local` è®¡ç®—å‡ºçš„ç´¢å¼•è¶…è¿‡ `sel_idx` çš„å®é™…é•¿åº¦æ—¶ï¼Œä¼šå‘ç”Ÿ IndexErrorã€‚

**å½±å“èŒƒå›´**:
- ROI è¿‡æ»¤å¤±è´¥
- è§„åˆ’å™¨å´©æºƒ
- åœ¨ç‚¹äº‘ç¨€ç–åœºæ™¯ä¸‹é«˜æ¦‚ç‡è§¦å‘

**ä¿®å¤å»ºè®®**:
```python
# ç¡®ä¿ç´¢å¼•ä¸è¶…è¿‡æ•°ç»„é•¿åº¦
if n_roi > self.cfg.guardrail_n_max:
    m = int(self.cfg.guardrail_n_max)
    # å®‰å…¨çš„é™é‡‡æ ·
    m = min(m, len(sel_idx))  # æ·»åŠ è¿™ä¸€è¡Œ
    if m > 0:
        ds_local = np.linspace(0, len(sel_idx) - 1, m, dtype=int)
        sel_idx = sel_idx[ds_local]
        pts_roi = pts[:, sel_idx]
        n_roi = pts_roi.shape[1]
```

---

### 3. æœªå¤„ç†çš„ç©ºç‚¹äº‘æƒ…å†µ - neupan.py

**é—®é¢˜ç±»å‹**: åŠŸèƒ½æ€§Bug  
**ä¸¥é‡ç¨‹åº¦**: ğŸ”´ é«˜  
**ä½ç½®**: `neupan/neupan.py:260-274`

**é—®é¢˜æè¿°**:
```python
# Line 260-262
robot_xy = state[:2, :]  # (2, 1) current position
heading_rad = float(state[2, 0])
v_robot = float(self.cur_vel_array[0, 0]) if self.cur_vel_array.shape[1] > 0 else 0.0
```

å¦‚æœ `state` çš„å½¢çŠ¶ä¸æ˜¯ `(3, 1)` è€Œæ˜¯ `(3,)` æˆ–å…¶ä»–å½¢çŠ¶ï¼Œ`state[2, 0]` ä¼šæŠ›å‡º IndexErrorã€‚

**å½±å“èŒƒå›´**:
- è§„åˆ’å™¨åˆå§‹åŒ–å¤±è´¥
- åœ¨æŸäº›ç¯å¢ƒä¸‹æ— æ³•å¯åŠ¨

**ä¿®å¤å»ºè®®**:
```python
# æ·»åŠ å½¢çŠ¶æ£€æŸ¥å’Œè§„èŒƒåŒ–
if state.ndim == 1:
    state = state.reshape(-1, 1)
if state.shape[0] < 3:
    raise ValueError(f"State must have at least 3 rows, got {state.shape}")

robot_xy = state[:2, :]
heading_rad = float(state[2, 0])
```

---

### 4. æ–‡ä»¶å¥æŸ„æ³„æ¼ - batch_core_modules_evaluation.py

**é—®é¢˜ç±»å‹**: èµ„æºæ³„æ¼  
**ä¸¥é‡ç¨‹åº¦**: ğŸŸ¡ ä¸­  
**ä½ç½®**: `test/batch_core_modules_evaluation.py:122, 436`

**é—®é¢˜æè¿°**:
```python
# Line 122
with open(abs_path, "r") as f:
    config = yaml.safe_load(f)
    config.update(kwargs)
```

è™½ç„¶ä½¿ç”¨äº† `with` è¯­å¥ï¼Œä½†åœ¨æŸäº›å¼‚å¸¸æƒ…å†µä¸‹ï¼ˆå¦‚ YAML è§£æå¤±è´¥ï¼‰ï¼Œæ–‡ä»¶å¯èƒ½æœªæ­£ç¡®å…³é—­ã€‚

**å½±å“èŒƒå›´**:
- é•¿æ—¶é—´è¿è¡Œçš„æ‰¹é‡æµ‹è¯•å¯èƒ½è€—å°½æ–‡ä»¶å¥æŸ„
- Windows ç³»ç»Ÿæ›´å®¹æ˜“è§¦å‘

**ä¿®å¤å»ºè®®**:
```python
try:
    with open(abs_path, "r") as f:
        config = yaml.safe_load(f)
except yaml.YAMLError as e:
    raise ValueError(f"Failed to parse YAML file {abs_path}: {e}")
except Exception as e:
    raise IOError(f"Failed to read file {abs_path}: {e}")

config.update(kwargs)
```

---

### 5. å­—å…¸é”®ç¼ºå¤±å¯¼è‡´ KeyError - neupan.py

**é—®é¢˜ç±»å‹**: åŠŸèƒ½æ€§Bug  
**ä¸¥é‡ç¨‹åº¦**: ğŸŸ¡ ä¸­  
**ä½ç½®**: `neupan/neupan.py:103-114`

**é—®é¢˜æè¿°**:
```python
cone_fov_base_deg=roi_kwargs.get("cone", {}).get("fov_base_deg", 90.0),
```

å¦‚æœ `roi_kwargs["cone"]` å­˜åœ¨ä½†ä¸æ˜¯å­—å…¸ï¼ˆä¾‹å¦‚æ˜¯ `None`ï¼‰ï¼Œ`.get()` ä¼šæŠ›å‡º AttributeErrorã€‚

**å½±å“èŒƒå›´**:
- ROI åˆå§‹åŒ–å¤±è´¥
- é…ç½®æ–‡ä»¶æ ¼å¼é”™è¯¯æ—¶å´©æºƒ

**ä¿®å¤å»ºè®®**:
```python
# å®‰å…¨çš„åµŒå¥—å­—å…¸è®¿é—®
def safe_nested_get(d, *keys, default=None):
    """å®‰å…¨åœ°ä»åµŒå¥—å­—å…¸ä¸­è·å–å€¼"""
    for key in keys:
        if not isinstance(d, dict):
            return default
        d = d.get(key, {})
    return d if d != {} else default

# ä½¿ç”¨ç¤ºä¾‹
cone_fov_base_deg = safe_nested_get(roi_kwargs, "cone", "fov_base_deg", default=90.0)
```

---

### 6. æ— é™å¾ªç¯é£é™© - roi_selector.py

**é—®é¢˜ç±»å‹**: ä¸¥é‡Bug - æ½œåœ¨æ­»é”  
**ä¸¥é‡ç¨‹åº¦**: ğŸ”´ é«˜  
**ä½ç½®**: `neupan/blocks/roi_selector.py:141-173`

**é—®é¢˜æè¿°**:
```python
if n_roi < self.cfg.guardrail_n_min:
    # Too few points, relax parameters and retry
    self._relax_parameters()
    # Retry with relaxed parameters
    mask = self._reachability_cone_mask(inputs)
    # ...
    if n_roi < self.cfg.guardrail_n_min:
        # Use fallback logic below
        pass  # åªæ‰§è¡Œä¸€æ¬¡ relaxï¼Œä½†å¦‚æœ relax åä»ä¸å¤Ÿæ€ä¹ˆåŠï¼Ÿ
```

å½“å‰ä»£ç åªå°è¯•ä¸€æ¬¡ relaxã€‚å¦‚æœç¯å¢ƒä¸­éšœç¢ç‚¹æå°‘ï¼ˆå¦‚ < 5 ä¸ªï¼‰ï¼Œå³ä½¿ relax åä»å¯èƒ½ä¸æ»¡è¶³ `n_min`ï¼Œä½†ä»£ç æ²¡æœ‰æ˜ç¡®çš„ fallback é€»è¾‘ã€‚

**å½±å“èŒƒå›´**:
- åœ¨ç¨€ç–ç‚¹äº‘ç¯å¢ƒä¸‹å¯èƒ½è¿”å›ä¸ç¬¦åˆé¢„æœŸçš„ç»“æœ
- è™½ç„¶æœ‰ fallbackï¼Œä½†é€»è¾‘ä¸æ¸…æ™°

**ä¿®å¤å»ºè®®**:
```python
# æ·»åŠ æœ€å¤§ relax æ¬¡æ•°é™åˆ¶
max_relax_attempts = 3
for attempt in range(max_relax_attempts):
    if n_roi >= self.cfg.guardrail_n_min:
        break
    self._relax_parameters()
    mask = self._reachability_cone_mask(inputs)
    mask = self._apply_always_keep(inputs, mask)
    sel_idx = np.flatnonzero(mask)
    pts_roi = pts[:, sel_idx]
    n_roi = pts_roi.shape[1]

# å¦‚æœä»ç„¶ä¸å¤Ÿï¼Œä½¿ç”¨ fallback
if n_roi < self.cfg.guardrail_n_min:
    # Fallback logic...
```

---

### 7. ç±»å‹è½¬æ¢é”™è¯¯ - robot.py

**é—®é¢˜ç±»å‹**: åŠŸèƒ½æ€§Bug  
**ä¸¥é‡ç¨‹åº¦**: ğŸŸ¡ ä¸­  
**ä½ç½®**: `neupan/robot/robot.py:262`

**é—®é¢˜æè¿°**:
```python
A = torch.Tensor([ [1, 0, -v * dt * sin(phi)], [0, 1, v * dt * cos(phi)], [0, 0, 1] ])
```

å¦‚æœ `v` æˆ– `phi` æ˜¯ `torch.Tensor` ä¸” `requires_grad=True`ï¼Œä¼šè§¦å‘è­¦å‘Šï¼š
```
UserWarning: Converting a tensor with requires_grad=True to a scalar may lead to unexpected behavior.
```

**å½±å“èŒƒå›´**:
- æ¢¯åº¦è®¡ç®—å¯èƒ½ä¸­æ–­
- è®­ç»ƒæ—¶å¯èƒ½å‡ºç°é—®é¢˜

**ä¿®å¤å»ºè®®**:
```python
# æ˜¾å¼åˆ†ç¦»æ¢¯åº¦
phi_val = phi.detach().item() if isinstance(phi, torch.Tensor) else phi
v_val = v.detach().item() if isinstance(v, torch.Tensor) else v

A = torch.Tensor([ [1, 0, -v_val * dt * sin(phi_val)], 
                   [0, 1, v_val * dt * cos(phi_val)], 
                   [0, 0, 1] ])
```

---

### 8. å¼‚å¸¸å¤„ç†è¿‡äºå®½æ³› - batch_core_modules_evaluation.py

**é—®é¢˜ç±»å‹**: ä»£ç è´¨é‡é—®é¢˜  
**ä¸¥é‡ç¨‹åº¦**: ğŸŸ¡ ä¸­  
**ä½ç½®**: `test/batch_core_modules_evaluation.py:276-286, 298-299, 377-378`

**é—®é¢˜æè¿°**:
```python
try:
    md = float(getattr(planner, 'min_distance', 0.0))
    min_d_list.append(md)
except Exception:
    pass  # åæ‰æ‰€æœ‰å¼‚å¸¸ï¼Œæ— æ³•è°ƒè¯•
```

ä½¿ç”¨ `except Exception: pass` ä¼šéšè—æ‰€æœ‰é”™è¯¯ï¼ŒåŒ…æ‹¬ç¼–ç¨‹é”™è¯¯ï¼ˆå¦‚ AttributeErrorã€TypeErrorï¼‰ã€‚

**å½±å“èŒƒå›´**:
- éš¾ä»¥è°ƒè¯•é—®é¢˜
- å¯èƒ½éšè—ä¸¥é‡é”™è¯¯

**ä¿®å¤å»ºè®®**:
```python
try:
    md = float(getattr(planner, 'min_distance', 0.0))
    min_d_list.append(md)
except (AttributeError, TypeError, ValueError) as e:
    # åªæ•è·é¢„æœŸçš„å¼‚å¸¸
    if not quiet:
        print(f"Warning: Failed to get min_distance: {e}")
```

---

## ğŸ“Š é—®é¢˜ç»Ÿè®¡

| ä¸¥é‡ç¨‹åº¦ | æ•°é‡ | ç±»å‹åˆ†å¸ƒ |
|---------|------|---------|
| ğŸ”´ é«˜ | 4 | é™¤é›¶é”™è¯¯(1), æ•°ç»„è¶Šç•Œ(1), ç©ºå€¼å¤„ç†(1), æ— é™å¾ªç¯(1) |
| ğŸŸ¡ ä¸­ | 4 | èµ„æºæ³„æ¼(1), KeyError(1), ç±»å‹è½¬æ¢(1), å¼‚å¸¸å¤„ç†(1) |
| ğŸŸ¢ ä½ | 0 | - |

**æ€»è®¡**: 8 ä¸ªä¸¥é‡/ä¸­ç­‰é—®é¢˜

---

## ğŸ” ä¸‹ä¸€æ­¥è¡ŒåŠ¨

1. **ç«‹å³ä¿®å¤** (ğŸ”´ é«˜ä¼˜å…ˆçº§):
   - é™¤é›¶é”™è¯¯ (robot.py:265)
   - æ•°ç»„è¶Šç•Œ (roi_selector.py:160, 179)
   - ç©ºç‚¹äº‘å¤„ç† (neupan.py:260-274)
   - æ— é™å¾ªç¯é£é™© (roi_selector.py:141-173)

2. **å°½å¿«ä¿®å¤** (ğŸŸ¡ ä¸­ä¼˜å…ˆçº§):
   - æ–‡ä»¶å¥æŸ„æ³„æ¼
   - å­—å…¸é”®ç¼ºå¤±
   - ç±»å‹è½¬æ¢è­¦å‘Š
   - å¼‚å¸¸å¤„ç†æ”¹è¿›

3. **ä»£ç å®¡æŸ¥å»¶ç»­**:
   - ç»§ç»­å®¡æŸ¥æ€§èƒ½ç“¶é¢ˆ
   - æ£€æŸ¥é‡å¤ä»£ç 
   - éªŒè¯ç®—æ³•æ­£ç¡®æ€§

---

**æŠ¥å‘Šç”Ÿæˆæ—¶é—´**: 2025-10-23  
**å®¡æŸ¥å·¥å…·**: äººå·¥ä»£ç å®¡æŸ¥ + é™æ€åˆ†æ  
**ä¸‹ä¸€ä»½æŠ¥å‘Š**: ä»£ç å®¡æŸ¥æŠ¥å‘Š_åŠŸèƒ½æ€§é—®é¢˜.md

