# 部署指南

<cite>
**本文档中引用的文件**  
- [README.md](file://README.md)
- [neupan/neupan.py](file://neupan/neupan.py)
- [neupan/blocks/dune.py](file://neupan/blocks/dune.py)
- [neupan/blocks/pan.py](file://neupan/blocks/pan.py)
- [neupan/blocks/nrmp.py](file://neupan/blocks/nrmp.py)
- [neupan/robot/robot.py](file://neupan/robot/robot.py)
- [example/run_exp.py](file://example/run_exp.py)
- [example/dune_train/dune_train_acker.py](file://example/dune_train/dune_train_acker.py)
- [example/dune_train/dune_train_diff.py](file://example/dune_train/dune_train_diff.py)
</cite>

## 目录
1. [引言](#引言)
2. [硬件性能与控制频率](#硬件性能与控制频率)
3. [系统性能监控方法](#系统性能监控方法)
4. [参数调优建议](#参数调优建议)
5. [DUNE模型的仿真到真实迁移性](#dune模型的仿真到真实迁移性)
6. [传感器校准与延迟补偿](#传感器校准与延迟补偿)
7. [结论](#结论)

## 引言
NeuPAN（Neural Proximal Alternating-minimization Network）是一种端到端、实时、无需地图且易于部署的基于模型预测控制（MPC）的机器人运动规划器。它通过将学习方法与优化技术相结合，直接将障碍点数据映射为控制动作，实现实时导航。该算法适用于差速驱动（diff）和阿克曼转向（acker）机器人，并已在IR-SIM仿真环境中验证其在复杂未知环境中的高效与安全性。

本指南旨在为在真实机器人平台上部署NeuPAN提供实用建议，重点涵盖CPU性能影响、系统性能监控、参数调优、DUNE模型可迁移性以及传感器校准等关键实践。

**Section sources**
- [README.md](file://README.md#L1-L50)

## 硬件性能与控制频率

NeuPAN的运行依赖于CPU进行数学优化求解，因此硬件平台的计算能力直接影响其控制频率。由于cvxpy优化求解器不支持GPU加速，推荐使用高性能CPU设备以实现更高的控制频率。

建议使用**Intel i7及以上级别处理器**，以确保控制频率达到**10Hz以上**。在实际测试中，Intel i7处理器可使NeuPAN稳定运行在15Hz以上的控制频率。若使用较低性能的CPU，可能导致forward步骤耗时过长，从而降低系统响应速度和避障能力。

用户可通过运行示例脚本`run_exp.py`来评估当前硬件平台的性能表现，并观察forward step的时间开销。

**Section sources**
- [README.md](file://README.md#L200-L220)

## 系统性能监控方法

为了评估NeuPAN在特定硬件上的运行效率，建议启用时间打印功能以监控forward步骤的执行时间。该功能可通过YAML配置文件中的`time_print`参数开启：

```yaml
time_print: True
```

当此参数设为`True`时，系统将在每次forward调用后输出其执行时间（单位：秒），便于用户分析算法延迟并判断是否满足实时性要求。

此外，可通过调整以下参数来优化运行效率：
- `receding`：减小预测步数可降低计算负担
- `dune_max_num` 和 `nrmp_max_num`：限制考虑的障碍点数量
- `iter_num`：减少迭代次数以加快收敛
- `iter_threshold`：适当放宽收敛阈值

这些参数的调整需在性能与精度之间权衡。

**Section sources**
- [README.md](file://README.md#L100-L130)
- [neupan/neupan.py](file://neupan/neupan.py#L1-L50)

## 参数调优建议

NeuPAN的行为受多个可调参数影响，用户可根据具体应用场景进行调优以最大化运行效率和导航性能。

### 核心可调参数（adjust部分）

| 参数名 | 默认值 | 说明 |
|--------|--------|------|
| `q_s` | 1.0 | 状态代价权重，值越大越贴近初始路径 |
| `p_u` | 1.0 | 速度代价权重，值越大越接近参考速度 |
| `ro_obs` | 400 | 避障惩罚参数，值越小可能需要更多迭代才能收敛 |
| `solver` | "ECOS" | NRMP层使用的优化求解器 |

建议根据实际场景动态调整这些参数。例如，在狭窄走廊中可适当提高`q_s`以增强路径跟踪能力；在开放区域可降低`ro_obs`以提升响应速度。

### 初始路径生成
初始路径可由全局规划器（如A*）提供，或通过NeuPAN内置功能从航点生成：
- 差速机器人：直线连接
- 阿克曼机器人：Dubins路径（前向行驶）或Reeds-Shepp路径（支持倒车）

可通过`set_initial_path`函数实时更新初始路径，适用于动态环境下的重规划。

**Section sources**
- [README.md](file://README.md#L150-L180)
- [neupan/neupan.py](file://neupan/neupan.py#L286)

## DUNE模型的仿真到真实迁移性

DUNE（Differentiable Unrolling Network for End-to-end Learning）模型在仿真中训练后可直接应用于真实世界，无需重新训练，展现出良好的跨域可迁移性。

### 模型训练条件
DUNE模型仅需针对特定机器人几何形状训练一次，后续可在不同环境中复用。以下情况需重新训练：
- 机器人尺寸或形状发生变化（如`vertices`、`length`、`width`变更）
- 机器人运动学类型改变（如从差速变为阿克曼）

训练时应确保`robot`部分的几何参数准确，并合理设置`data_range`以覆盖传感器感知范围。

### 训练流程
用户可参考`example/dune_train`目录下的示例进行模型训练：
- `dune_train_diff.py`：用于差速机器人
- `dune_train_acker.py`：用于阿克曼机器人

训练过程通常耗时1–2小时，生成的模型可保存并用于后续部署。

**Section sources**
- [README.md](file://README.md#L220-L250)
- [example/dune_train/dune_train_acker.py](file://example/dune_train/dune_train_acker.py)
- [example/dune_train/dune_train_diff.py](file://example/dune_train/dune_train_diff.py)

## 传感器校准与延迟补偿

### 传感器输入兼容性
NeuPAN接受2D点云作为障碍物输入，支持多种传感器：
- **3D激光雷达**：可通过投影至地面平面转换为2D点云（如ROS中的`pointcloud_to_laserscan`）
- **相机**：可通过图像处理提取2D障碍点

确保传感器坐标系与机器人基坐标系正确对齐，避免因标定误差导致避障失败。

### 延迟补偿策略
由于传感器数据采集与处理存在延迟，建议采取以下措施：
1. **时间戳同步**：确保所有传感器数据带有精确时间戳，并与规划器时钟同步
2. **状态预测**：基于机器人当前速度和角速度预测未来时刻位姿，用于障碍物映射
3. **缓冲机制**：设置合理的数据缓存窗口，避免因瞬时延迟导致规划中断

在ROS集成中，可通过`neupan_ros`包实现上述同步与补偿机制。

**Section sources**
- [README.md](file://README.md#L250-L270)
- [neupan/blocks/dune.py](file://neupan/blocks/dune.py#L1-L20)

## 结论

NeuPAN作为一种高效的端到端运动规划器，具备良好的实时性与可部署性。为确保其在真实机器人平台上的稳定运行，建议：
- 使用Intel i7及以上CPU以保障10Hz以上的控制频率
- 启用`time_print`功能监控forward步骤执行时间
- 根据场景需求调优`adjust`参数以平衡性能与行为
- 正确训练并迁移DUNE模型以适应机器人几何特性
- 实施传感器校准与延迟补偿以提升系统鲁棒性

通过合理配置与调优，NeuPAN可在真实环境中实现安全、高效的自主导航。

**Section sources**
- [README.md](file://README.md#L200-L270)