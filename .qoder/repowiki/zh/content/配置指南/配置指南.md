# 配置指南

<cite>
**本文档中引用的文件**  
- [neupan.py](file://neupan/neupan.py)
- [robot.py](file://neupan/robot/robot.py)
- [initial_path.py](file://neupan/blocks/initial_path.py)
- [planner.yaml](file://example/corridor/diff/planner.yaml)
- [planner.yaml](file://example/corridor/acker/planner.yaml)
- [planner.yaml](file://example/LON/planner.yaml)
- [dune_train_acker.py](file://example/dune_train/dune_train_acker.py)
</cite>

## 目录
1. [引言](#引言)
2. [顶级参数详解](#顶级参数详解)
3. [robot 参数配置](#robot-参数配置)
4. [ipath 路径生成策略](#ipath-路径生成策略)
5. [pan 优化网络配置](#pan-优化网络配置)
6. [adjust 调整参数](#adjust-调整参数)
7. [train 训练参数](#train-训练参数)
8. [参数调优建议](#参数调优建议)
9. [结论](#结论)

## 引言
NeuPAN 是一种基于模型预测控制（MPC）的路径规划算法，其行为由 YAML 配置文件中的多个参数决定。本指南旨在全面解析 NeuPAN 的 YAML 配置系统，详细说明 `receding`、`step_time`、`robot`、`ipath`、`pan`、`adjust` 和 `train` 等顶级参数的含义与作用。同时，深入探讨 `robot` 子参数的配置规则、`ipath` 中的路径生成策略，并提供关键参数的调优建议。

**Section sources**
- [neupan.py](file://neupan/neupan.py#L20-L70)

## 顶级参数详解
NeuPAN 的配置文件由多个顶级参数构成，这些参数共同定义了规划器的核心行为。

### receding
`receding` 参数定义了模型预测控制（MPC）框架中的**预测时域步数**。它决定了规划器在每一步向前看多远来优化轨迹。较大的 `receding` 值能生成更全局、更平滑的轨迹，但会显著增加计算负担，影响实时性。较小的值则计算更快，但可能导致局部次优或震荡。

**Section sources**
- [neupan.py](file://neupan/neupan.py#L20-L22)

### step_time
`step_time` 参数指定了 MPC 框架中的**时间步长**（单位：秒）。它与 `receding` 共同决定了预测时域的总时间（`receding * step_time`）。较小的 `step_time` 可以提供更精细的时间分辨率，但同样会增加计算量。该值应与机器人的控制周期和传感器更新频率相匹配。

**Section sources**
- [neupan.py](file://neupan/neupan.py#L22-L23)

### ref_speed
`ref_speed` 是机器人期望的**参考速度**（单位：m/s）。规划器会尝试生成接近此速度的轨迹。在 `ipath` 模块中，它用于生成初始路径的点间距（`interval = step_time * ref_speed`）。

**Section sources**
- [neupan.py](file://neupan/neupan.py#L23-L24)

### device
`device` 指定算法运行的硬件设备，可选 `'cpu'` 或 `'cuda'`。使用 `'cuda'` 可以利用 GPU 加速，显著提升计算速度，尤其是在处理复杂环境或长时域时。

**Section sources**
- [neupan.py](file://neupan/neupan.py#L24-L25)

### collision_threshold
`collision_threshold` 定义了**碰撞检测的阈值**（单位：米）。当规划器检测到机器人与障碍物的最小距离小于此值时，将判定为碰撞，并停止规划。该值应略大于机器人的安全裕度。

**Section sources**
- [neupan.py](file://neupan/neupan.py#L26-L27)

## robot 参数配置
`robot` 部分定义了机器人的运动学模型和物理约束，是配置的核心。

### kinematics
`kinematics` 指定机器人的**运动学类型**，目前支持 `'diff'`（差速驱动）和 `'acker'`（阿克曼转向）。
- **差速驱动 (diff)**：通过左右轮速度差实现转向，其转向角速度 `max_speed[1]` 通常以 rad/s 为单位。
- **阿克曼转向 (acker)**：前轮转向，后轮驱动，其转向角速度 `max_speed[1]` 实际上是前轮的最大转向角（单位：rad），代码中会进行限制（最大 1.57 rad ≈ 90°）。

**Section sources**
- [robot.py](file://neupan/robot/robot.py#L55-L57)
- [robot.py](file://neupan/robot/robot.py#L85-L88)

### vertices
`vertices` 定义了机器人轮廓的**顶点坐标**，用于精确的碰撞检测。它是一个二维列表，如 `[[x1, y1], [x2, y2], ...]`。如果未提供，系统将根据 `length` 和 `width` 自动生成一个矩形轮廓。

**Section sources**
- [robot.py](file://neupan/robot/robot.py#L120-L140)

### max_speed 和 max_acce
- `max_speed`：一个包含两个元素的列表，分别表示**线速度**（m/s）和**角速度/转向角速度**（rad/s 或 rad）的最大值。
- `max_acce`：一个包含两个元素的列表，分别表示**线加速度**（m/s²）和**角加速度**（rad/s²）的最大值。
这两个参数用于在优化问题中施加速度和加速度的约束，确保生成的轨迹符合机器人的动力学能力。

**Section sources**
- [robot.py](file://neupan/robot/robot.py#L58-L62)
- [robot.py](file://neupan/robot/robot.py#L94-L99)

### length, width, wheelbase
对于矩形机器人，可以直接通过 `length`（长度）、`width`（宽度）和 `wheelbase`（轴距）来定义其尺寸。`wheelbase` 仅对阿克曼转向机器人有意义，用于计算其运动学模型。

**Section sources**
- [robot.py](file://neupan/robot/robot.py#L63-L66)
- [robot.py](file://neupan/robot/robot.py#L130-L135)

## ipath 路径生成策略
`ipath` 模块负责从给定的路点（waypoints）生成一条初始路径。

### waypoints
`waypoints` 是一个路点列表，每个路点是一个 `[x, y, theta]` 的三元组，定义了路径上的关键位置和朝向。

**Section sources**
- [initial_path.py](file://neupan/blocks/initial_path.py#L35-L45)

### curve_style
`curve_style` 决定了连接路点所使用的**曲线类型**：
- **'line'**：使用直线连接路点。最简单，计算最快，适用于无障碍的开阔区域。
- **'dubins'**：生成 Dubins 曲线，由直线段和圆弧段组成，适用于前向行驶且转向半径受限的场景。
- **'reeds'**：生成 Reeds-Shepp 曲线，允许前进和后退，比 Dubins 曲线更灵活，可以生成更短的路径。

**选择依据**：如果机器人需要倒车或在狭窄空间内机动，应选择 `'reeds'`；如果只允许前进，则 `'dubins'` 是更好的选择；对于简单场景，`'line'` 就足够了。

**Section sources**
- [initial_path.py](file://neupan/blocks/initial_path.py#L45-L47)
- [planner.yaml](file://example/corridor/diff/planner.yaml#L15-L17)

### min_radius
`min_radius` 定义了生成 Dubins 或 Reeds-Shepp 曲线时的**最小转弯半径**（单位：米）。该值应根据机器人的物理特性（如阿克曼转向的最小转弯半径）来设置。

**Section sources**
- [initial_path.py](file://neupan/blocks/initial_path.py#L48-L49)

## pan 优化网络配置
`pan` 部分配置了 Proximal Alternating Minimization Network 的核心参数。

### iter_num
`iter_num` 指定了 PAN 优化器的**迭代次数**。每次迭代都会使轨迹更接近最优解。增加此值可以提高规划质量，但会线性增加计算时间。

**Section sources**
- [planner.yaml](file://example/corridor/diff/planner.yaml#L32-L33)

### dune_max_num 和 nrmp_max_num
- `dune_max_num`：DUNE（深度不确定性神经网络）层在优化中考虑的**最大障碍物点数**。
- `nrmp_max_num`：NRMP（非线性相对度量势）层在优化中考虑的**最大障碍物点数**。
这两个参数影响计算复杂度和避障的精细程度。

**Section sources**
- [planner.yaml](file://example/corridor/diff/planner.yaml#L34-L35)

### dune_checkpoint
`dune_checkpoint` 指定了预训练的 DUNE 模型的**检查点路径**。该模型用于学习和预测障碍物的运动模式。如果为 `None`，则不使用 DUNE 模型。

**Section sources**
- [planner.yaml](file://example/corridor/diff/planner.yaml#L38-L39)

### iter_threshold
`iter_threshold` 是优化过程的**收敛阈值**。当连续两次迭代的解的变化量小于此值时，优化过程将提前终止。

**Section sources**
- [planner.yaml](file://example/corridor/diff/planner.yaml#L37-L38)

## adjust 调整参数
`adjust` 参数用于调整优化问题中各项成本函数的权重。

### q_s, p_u, eta
- `q_s`：**状态成本权重**。控制轨迹与参考路径的贴合程度。
- `p_u`：**控制成本权重**。控制输入（速度）的平滑性，值越大，速度变化越平缓。
- `eta`：**避障成本权重**。控制避障的强度，值越大，机器人会离障碍物越远。

**Section sources**
- [neupan.py](file://neupan/neupan.py#L330-L345)

### d_max, d_min
- `d_max`：**最大避障距离**。当机器人与障碍物的距离大于此值时，避障成本为零。
- `d_min`：**最小安全距离**。机器人与障碍物的距离不应小于此值，否则视为碰撞。

**Section sources**
- [neupan.py](file://neupan/neupan.py#L330-L345)

## train 训练参数
`train` 部分用于配置 DUNE 模型的训练参数。在 `dune_train_acker.py` 示例中，通过 `init_from_yaml` 加载配置并调用 `train_dune()` 方法进行训练。`data_range` 是一个关键参数，它决定了模型在训练时考虑的障碍物点的最大范围。

**Section sources**
- [dune_train_acker.py](file://example/dune_train/dune_train_acker.py#L4-L5)
- [README.md](file://README.md#L210-L214)

## 参数调优建议
合理配置参数是平衡实时性与规划质量的关键。

### 调整 receding 步数
- **硬件性能强 (GPU)**：可设置较大的 `receding`（如 15-20）和较小的 `step_time`（如 0.05s），以获得更优的全局轨迹。
- **硬件性能弱 (CPU)**：应减小 `receding`（如 8-12）或增大 `step_time`（如 0.2s），以保证实时性。可通过 `time_print: True` 监控计算时间。

### 配置 robot 参数
- 确保 `kinematics` 与实际机器人类型一致。
- `max_speed` 和 `max_acce` 必须根据机器人实测数据设置，否则可能导致轨迹不可行。
- 对于阿克曼机器人，`wheelbase` 必须准确，它直接影响运动学模型的精度。

### 平衡 adjust 权重
- 在开阔区域，可适当降低 `eta`，让机器人更贴近参考路径。
- 在狭窄或动态环境中，应提高 `eta` 和 `d_max`，增强避障能力。
- 增大 `p_u` 可使速度曲线更平滑，减少对机器人的冲击。

**Section sources**
- [neupan.py](file://neupan/neupan.py#L20-L27)
- [robot.py](file://neupan/robot/robot.py#L85-L88)
- [neupan.py](file://neupan/neupan.py#L330-L345)

## 结论
NeuPAN 的 YAML 配置系统提供了高度的灵活性，允许用户根据具体的应用场景和硬件平台进行精细调优。理解每个参数的物理意义和相互影响是成功应用 NeuPAN 的关键。通过合理配置 `receding`、`robot`、`ipath` 和 `adjust` 等参数，可以在保证实时性的前提下，生成高质量、安全的运动轨迹。