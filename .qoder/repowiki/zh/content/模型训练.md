# 模型训练

<cite>
**本文档中引用的文件**  
- [dune_train_acker.py](file://example/dune_train/dune_train_acker.py)
- [dune_train_diff.py](file://example/dune_train/dune_train_diff.py)
- [dune_train_acker.yaml](file://example/dune_train/dune_train_acker.yaml)
- [dune_train_diff.yaml](file://example/dune_train/dune_train_diff.yaml)
- [dune.py](file://neupan/blocks/dune.py)
- [dune_train.py](file://neupan/blocks/dune_train.py)
- [robot.py](file://neupan/robot/robot.py)
- [neupan.py](file://neupan/neupan.py)
</cite>

## 目录
1. [简介](#简介)
2. [机器人轮廓定义](#机器人轮廓定义)
3. [训练数据生成与data_range参数](#训练数据生成与data_range参数)
4. [训练超参数设置与调优](#训练超参数设置与调优)
5. [完整训练脚本示例](#完整训练脚本示例)
6. [验证与模型保存频率控制](#验证与模型保存频率控制)
7. [训练流程总结](#训练流程总结)

## 简介
DUNE（Deep Unfolded Neural Encoder）模型是NeuPAN路径规划算法的核心组件，负责将障碍物点云映射到潜在的距离特征空间（mu和lambda），从而实现高效的避障决策。本指南详细说明如何为自定义机器人几何形状训练专属的DUNE模型，涵盖从轮廓定义、数据生成、超参数调优到完整训练脚本的全过程。

**Section sources**
- [dune.py](file://neupan/blocks/dune.py#L0-L211)

## 机器人轮廓定义
在训练DUNE模型之前，必须正确定义机器人的几何轮廓。这是训练过程的基础，直接影响模型对机器人与障碍物之间距离的计算精度。

轮廓可以通过两种方式定义：
1.  **通过vertices参数直接指定顶点**：提供一个包含机器人轮廓所有顶点坐标的列表或数组，格式为`[[x1, y1], [x2, y2], ...]`。
2.  **通过length/width参数定义矩形轮廓**：对于常见的矩形机器人，只需指定`length`（长度）和`width`（宽度）即可。系统会自动调用`cal_vertices_from_length_width`方法生成四个顶点。

轮廓信息最终用于生成线性不等式约束矩阵`G`和向量`h`，这些参数定义了机器人在二维平面中的可行空间。此步骤在`robot`类的`__init__`方法中完成。

**Section sources**
- [robot.py](file://neupan/robot/robot.py#L0-L349)

## 训练数据生成与data_range参数
DUNE模型的训练数据是通过求解一个凸优化问题在线生成的。对于训练域内的每一个随机采样点`p`，系统会计算出一个最优的拉格朗日乘子`mu`和一个距离值，这些值作为神经网络的标签。

`data_range`参数至关重要，它定义了训练数据的生成范围，格式为`[low_x, low_y, high_x, high_y]`。该参数直接影响模型的训练域：
- **影响训练域**：`data_range`决定了模型在哪个空间区域内学习距离函数。如果`data_range`过小，模型可能无法泛化到训练区域之外的场景，导致在实际应用中出现意外行为。
- **推荐设置**：应根据机器人实际工作环境的大小来设定。例如，在`dune_train_acker.yaml`中，`data_range: [-25, -25, 25, 25]`表示在一个50x50米的正方形区域内生成训练数据，这适用于大多数室外场景。

数据生成的核心逻辑在`DUNETrain`类的`generate_data_set`方法中实现，它使用`cvxpy`库求解优化问题以获得精确的标签。

**Section sources**
- [dune_train.py](file://neupan/blocks/dune_train.py#L34-L83)
- [dune_train_acker.yaml](file://example/dune_train/dune_train_acker.yaml#L7-L8)

## 训练超参数设置与调优
合理的超参数设置是成功训练DUNE模型的关键。以下是主要超参数的设置原则和调优技巧：

- **`batch_size` (批量大小)**：默认值为256。较大的`batch_size`可以提供更稳定的梯度估计，加快训练速度，但会增加内存消耗。如果出现内存不足（OOM）错误，应尝试减小该值。
- **`epoch` (训练轮数)**：默认值为5000。这表示整个训练数据集将被遍历5000次。训练轮数不足可能导致模型欠拟合，而过多则可能导致过拟合。应结合验证损失来判断。
- **`lr` (学习率)**：默认值为5e-5。学习率控制了模型参数更新的步长。过高的学习率可能导致训练不稳定，损失值震荡；过低的学习率则会使训练过程非常缓慢。`lr_decay`和`decay_freq`参数用于在训练过程中逐步降低学习率，以帮助模型收敛到更优的解。
- **`data_size` (数据量)**：默认值为100000。更大的数据量通常能训练出泛化能力更强的模型，但会增加数据生成和训练的时间成本。

调优技巧：建议先使用默认参数进行一次完整训练，观察`results.txt`文件中的训练和验证损失曲线。如果验证损失在后期上升，说明可能过拟合，可尝试增加`weight_decay`或使用更小的`lr`。如果损失下降缓慢，可尝试适当增大`lr`。

**Section sources**
- [dune_train.py](file://neupan/blocks/dune_train.py#L34-L83)
- [dune_train_acker.yaml](file://example/dune_train/dune_train_acker.yaml#L9-L19)

## 完整训练脚本示例
以下是一个完整的训练脚本示例，展示了如何从YAML配置文件初始化并启动DUNE模型的训练。

```python
from neupan import neupan

if __name__ == '__main__':
    # 从YAML配置文件加载参数并初始化neupan规划器
    neupan_planner = neupan.init_from_yaml('dune_train_acker.yaml')
    # 启动DUNE模型训练
    neupan_planner.train_dune()
```

该脚本位于`example/dune_train/`目录下，如`dune_train_acker.py`。YAML配置文件（如`dune_train_acker.yaml`）集中定义了机器人参数（`robot`部分）和训练参数（`train`部分），实现了配置与代码的分离，便于管理和复现。

**Section sources**
- [dune_train_acker.py](file://example/dune_train/dune_train_acker.py#L0-L5)
- [dune_train_acker.yaml](file://example/dune_train/dune_train_acker.yaml#L0-L19)
- [neupan.py](file://neupan/neupan.py#L370-L373)

## 验证与模型保存频率控制
在训练过程中，系统会定期进行验证和保存模型，以监控训练进度并防止意外中断导致的成果丢失。

- **验证频率 (`valid_freq`)**：每训练`valid_freq`个epoch，模型会在验证集上进行一次评估。验证损失与训练损失的对比是判断模型是否过拟合的重要依据。在示例配置中，`valid_freq: 250`表示每250个epoch验证一次。
- **模型保存频率 (`save_freq`)**：每训练`save_freq`个epoch，模型的当前状态（权重）会被保存到磁盘。这允许用户在训练中断后从最近的检查点恢复，或选择验证损失最低的模型进行部署。在示例配置中，`save_freq: 500`表示每500个epoch保存一次。

这两个频率的控制逻辑在`DUNETrain`类的`start`方法中通过`if i % valid_freq == 0:`和`if i % save_freq == 0:`条件判断实现。建议`save_freq`的值大于或等于`valid_freq`，以避免过于频繁的I/O操作影响训练效率。

**Section sources**
- [dune_train.py](file://neupan/blocks/dune_train.py#L34-L83)
- [dune_train_acker.yaml](file://example/dune_train/dune_train_acker.yaml#L11-L13)

## 训练流程总结
DUNE模型的训练流程可以总结为以下几个关键步骤：
1.  **定义机器人轮廓**：通过`vertices`或`length/width`参数在YAML配置文件中明确机器人的几何形状。
2.  **配置训练参数**：在YAML文件的`train`部分设置`data_size`, `data_range`, `batch_size`, `epoch`, `lr`等超参数。
3.  **启动训练脚本**：运行如`dune_train_acker.py`之类的脚本，该脚本会加载YAML配置并调用`neupan_planner.train_dune()`。
4.  **数据生成与训练**：`DUNETrain`类根据`data_range`生成训练和验证数据集，并使用Adam优化器进行多轮训练。
5.  **监控与保存**：训练过程中，系统会按`valid_freq`和`save_freq`的设定，定期输出验证结果并保存模型检查点。

遵循此流程，用户可以为任何具有自定义几何形状的机器人成功训练出专属的DUNE模型。

**Section sources**
- [dune.py](file://neupan/blocks/dune.py#L137-L173)
- [dune_train.py](file://neupan/blocks/dune_train.py#L34-L83)