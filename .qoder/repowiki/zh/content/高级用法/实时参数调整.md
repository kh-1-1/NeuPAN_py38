# 实时参数调整

<cite>
**本文档中引用的文件**  
- [neupan.py](file://neupan/neupan.py)
- [nrmp.py](file://neupan/blocks/nrmp.py)
- [initial_path.py](file://neupan/blocks/initial_path.py)
- [pan.py](file://neupan/blocks/pan.py)
</cite>

## 目录
1. [引言](#引言)
2. [核心参数及其作用机制](#核心参数及其作用机制)
3. [update_adjust_parameters 方法详解](#update_adjust_parameters-方法详解)
4. [典型场景下的参数调优实践](#典型场景下的参数调优实践)
5. [动态参考速度与路径重规划](#动态参考速度与路径重规划)
6. [运行时参数监控与访问](#运行时参数监控与访问)
7. [结论](#结论)

## 引言
NeuPAN系统是一种基于神经正则化运动规划（NRMP）与深度不确定性感知网络（DUNE）相结合的先进路径规划框架，适用于复杂动态环境中的自主导航。该系统支持在运行时对关键规划参数进行实时调整，以适应不同环境条件和任务需求。本文档系统阐述`adjust`参数的实时调整策略及其对规划行为的影响，重点分析`update_adjust_parameters`方法的工作原理，并提供在狭窄走廊和开阔区域等典型场景下的调优指南。

**Section sources**
- [neupan.py](file://neupan/neupan.py#L0-L402)

## 核心参数及其作用机制
NeuPAN系统中的`adjust`参数集直接影响路径规划器的行为特性，主要包括以下五个关键参数：

- **q_s**: 状态成本权重，控制机器人状态（位置、姿态）与参考轨迹的跟踪精度。增大`q_s`可增强轨迹跟踪能力，但可能导致控制过于激进。
- **p_u**: 速度成本权重，影响控制输入（速度、角速度）的平滑性。较高的`p_u`值有助于生成更平滑的控制指令，减少机械磨损。
- **eta**: 避障成本权重，决定避障行为的敏感度。`eta`越大，系统越倾向于远离障碍物，适合高风险环境。
- **d_max**: 障碍物最大距离阈值，定义避障成本函数起作用的最大距离。超出此距离的障碍物对规划影响较小。
- **d_min**: 障碍物最小安全距离阈值，确保机器人与障碍物之间保持最低安全距离。低于此值将触发强避障响应。

这些参数共同构成优化问题中的代价函数与约束条件，直接影响NRMP层的求解结果。

**Section sources**
- [nrmp.py](file://neupan/blocks/nrmp.py#L0-L325)

## update_adjust_parameters 方法详解
`update_adjust_parameters`方法是NeuPAN系统中用于动态调整规划参数的核心接口。该方法通过更新NRMP层中的可学习参数，实现对规划行为的实时调控。

### 工作流程
1. 方法接收任意数量的关键字参数（如`q_s`, `p_u`, `eta`等）。
2. 将参数传递至`self.pan.nrmp_layer.update_adjust_parameters_value(**kwargs)`进行实际更新。
3. 在`NRMP`类中，各参数被转换为可微张量（`value_to_tensor`），并重新构建参数列表`adjust_parameters`。
4. 更新后的参数在后续的MPC优化循环中生效，影响代价函数`nav_cost`与`dune_cost`的计算。

### 代价函数影响分析
```mermaid
flowchart TD
A[代价函数] --> B[导航成本 nav_cost]
A --> C[避障成本 dune_cost]
B --> D[q_s * ||s - ref_s||²]
B --> E[p_u * ||u - ref_u||²]
C --> F[-eta * Σd]
C --> G[d_min ≤ d ≤ d_max]
```

**Diagram sources**
- [nrmp.py](file://neupan/blocks/nrmp.py#L250-L275)

**Section sources**
- [neupan.py](file://neupan/neupan.py#L334-L347)
- [nrmp.py](file://neupan/blocks/nrmp.py#L180-L195)

## 典型场景下的参数调优实践

### 狭窄走廊（corridor）场景
在狭窄环境中，应优先保证避障安全性：
- **提高`eta`值**（例如从10.0提升至20.0），增强避障成本权重，使机器人更主动远离墙壁。
- **适当增加`d_max`**（例如从1.0提升至1.5），扩大感知范围，提前响应潜在碰撞。
- **保持`d_min`不变或略增**（如0.1→0.15），确保最小安全距离。
- **降低`p_u`**，允许更大的速度调整自由度以应对突发障碍。

示例调用：
```python
neupan_instance.update_adjust_parameters(eta=20.0, d_max=1.5, d_min=0.15, p_u=0.5)
```

### 开阔区域（dune_train）场景
在开阔区域可追求高速平稳行驶：
- **降低`eta`值**（例如从10.0降至5.0），减少不必要的避障行为，提升通行效率。
- **提高`q_s`与`p_u`的平衡**，例如设置`q_s=2.0, p_u=1.5`，以实现精准轨迹跟踪与平滑控制。
- **适当降低`d_max`**（如1.0→0.8），聚焦近场障碍物，避免远距离噪声干扰。

示例调用：
```python
neupan_instance.update_adjust_parameters(q_s=2.0, p_u=1.5, eta=5.0, d_max=0.8)
```

**Section sources**
- [example/corridor](file://example/corridor)
- [example/dune_train](file://example/dune_train)

## 动态参考速度与路径重规划

### 动态修改参考速度
通过`set_reference_speed`方法可实时调整机器人的期望行驶速度。该方法同步更新`ipath.ref_speed`与`neupan.ref_speed`，确保初始路径生成与MPC优化使用一致的速度基准。

```python
neupan_instance.set_reference_speed(6.0)  # 设置参考速度为6.0 m/s
```

**Section sources**
- [neupan.py](file://neupan/neupan.py#L303-L311)

### 目标导向的路径重规划
`update_initial_path_from_goal`方法支持基于当前起点与目标点动态生成初始路径。该方法调用`curve_generator`生成从`start`到`goal`的几何曲线（如直线或样条），并重新分割路径段（含挡位信息），为后续MPC优化提供新的参考轨迹。

```python
neupan_instance.update_initial_path_from_goal(start_state, goal_state)
```

此机制适用于目标点动态变化或环境突变导致原路径失效的场景。

**Section sources**
- [neupan.py](file://neupan/neupan.py#L313-L321)
- [initial_path.py](file://neupan/blocks/initial_path.py#L351-L370)

## 运行时参数监控与访问
NeuPAN系统提供`adjust_parameters`属性用于运行时监控当前的调整参数。该属性返回`nrmp_layer`中维护的参数列表`[q_s, p_u, eta, d_max, d_min]`，便于外部系统读取或日志记录。

```python
current_params = neupan_instance.adjust_parameters
print("当前调整参数:", current_params)
```

此外，结合`opt_trajectory`与`ref_trajectory`属性，可实现对规划效果的可视化与性能评估。

**Section sources**
- [neupan.py](file://neupan/neupan.py#L400-L402)

## 结论
NeuPAN系统通过`update_adjust_parameters`、`set_reference_speed`和`update_initial_path_from_goal`等接口，实现了高度灵活的实时规划行为调控。合理配置`q_s`、`p_u`、`eta`、`d_max`和`d_min`等参数，可在不同场景下平衡轨迹跟踪精度、控制平滑性与避障安全性。结合运行时参数监控，开发者能够构建自适应的智能导航系统，有效应对复杂多变的实际应用环境。