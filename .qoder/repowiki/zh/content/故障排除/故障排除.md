# 故障排除

<cite>
**本文档中引用的文件**  
- [neupan.py](file://neupan/neupan.py)
- [nrmp.py](file://neupan/blocks/nrmp.py)
- [pan.py](file://neupan/blocks/pan.py)
- [initial_path.py](file://neupan/blocks/initial_path.py)
- [util.py](file://neupan/util/__init__.py)
- [planner.yaml](file://example/LON/planner.yaml)
- [env.yaml](file://example/corridor/diff/env.yaml)
</cite>

## 目录
1. [引言](#引言)
2. [规划器运行缓慢](#规划器运行缓慢)
3. [机器人发生碰撞](#机器人发生碰撞)
4. [无法收敛到目标](#无法收敛到目标)
5. [性能瓶颈诊断](#性能瓶颈诊断)
6. [调试技巧](#调试技巧)

## 引言
本指南旨在帮助用户解决在使用NeuPAN导航算法过程中可能遇到的常见问题。NeuPAN是一种基于模型的端到端运动规划器，通过实时求解包含点级避障约束的数学优化问题来实现安全导航。本文将针对规划器运行缓慢、机器人碰撞以及路径无法收敛等典型问题，提供详细的可能原因分析和解决方案，并介绍如何利用调试工具进行问题排查。

## 规划器运行缓慢

当NeuPAN规划器的控制频率低于预期（如低于10Hz）时，可能导致机器人响应迟缓。造成此问题的主要原因及解决方案如下：

**可能原因：**
1.  **硬件计算能力不足**：NeuPAN依赖CPU进行实时优化求解，计算密集。
2.  **YAML配置参数设置不当**：某些参数会显著增加计算复杂度。
3.  **点云数据量过大**：输入的障碍物点云过多会增加DUNE和NRMP层的计算负担。

**解决方案：**
1.  **升级硬件**：推荐使用高性能CPU（如Intel i7）以提升计算速度。
2.  **调整YAML参数**：在`planner.yaml`文件中，适当减小以下参数值：
    -   `receding`：减小MPC的预测步数。
    -   `dune_max_num`：减少DUNE层考虑的障碍物点最大数量。
    -   `nrmp_max_num`：减少NRMP层考虑的障碍物点最大数量。
    -   `iter_num`：减少PAN网络的迭代次数。
    -   `iter_threshold`：适当放宽迭代收敛阈值。
3.  **优化点云数据**：通过`scan_to_point`函数的`down_sample`参数对输入的激光雷达数据进行降采样，或在传感器端过滤无效点。

**Section sources**
- [neupan.py](file://neupan/neupan.py#L368-L401)
- [nrmp.py](file://neupan/blocks/nrmp.py#L34-L80)
- [pan.py](file://neupan/blocks/pan.py#L105-L140)

## 机器人发生碰撞

机器人在运行过程中与障碍物发生物理接触，表明避障功能失效。

**可能原因：**
1.  **机器人尺寸配置错误**：YAML文件中`robot`部分的`vertices`、`length`或`width`参数与实际机器人尺寸不匹配，导致DUNE模型学习的碰撞边界错误。
2.  **点云数据有效性问题**：传感器数据丢失、噪声过大或坐标转换错误，导致规划器未能“看到”真实障碍物。
3.  **避障权重过低**：`adjust`参数中的`ro_obs`值过小，导致碰撞惩罚项在优化目标中的权重不足，规划器倾向于忽略障碍物。
4.  **碰撞检测阈值过高**：`collision_threshold`设置过大，导致规划器在距离障碍物很近时才判定为碰撞并停止。

**解决方案：**
1.  **核对机器人尺寸**：仔细检查`planner.yaml`文件中`robot`部分的几何参数，确保其准确反映真实机器人的尺寸和形状。
2.  **验证点云数据**：使用`dune_points`和`nrmp_points`属性获取规划器实际接收到的障碍物点，并进行可视化，确认数据的完整性和正确性。
3.  **增大避障权重**：在`planner.yaml`的`adjust`部分，尝试增大`ro_obs`的值（默认为400），以加强避障约束。
4.  **降低碰撞阈值**：减小`collision_threshold`的值（默认为0.1），使规划器对近距离障碍物更敏感。

**Section sources**
- [neupan.py](file://neupan/neupan.py#L130-L175)
- [nrmp.py](file://neupan/blocks/nrmp.py#L260-L324)
- [planner.yaml](file://example/LON/planner.yaml)

## 无法收敛到目标

规划器生成的轨迹无法引导机器人到达目标点，或在目标点附近持续振荡。

**可能原因：**
1.  **初始路径质量差**：提供的初始路径（如由A*生成）过于曲折或与最优路径偏差过大，导致优化过程难以收敛。
2.  **状态成本权重不当**：`adjust`参数中的`q_s`值过大，导致规划器过于严格地贴合初始路径，无法根据障碍物信息进行有效调整。
3.  **参考速度设置不合理**：设定的`ref_speed`过高，超出了机器人动力学或环境允许的范围。
4.  **DUNE模型未针对当前机器人训练**：如果机器人尺寸或形状发生改变，但未重新训练DUNE模型，其学习到的避障行为将不准确。

**解决方案：**
1.  **优化初始路径**：确保初始路径是平滑且合理的。可以使用`update_initial_path_from_waypoints`动态更新路径。
2.  **调整`q_s`权重**：适当减小`adjust`部分的`q_s`值，允许规划器在必要时偏离初始路径以避开障碍物。
3.  **降低参考速度**：尝试降低`ref_speed`的值，使规划问题更容易求解。
4.  **重新训练DUNE模型**：当机器人几何形状改变时，必须使用`train_dune`方法重新训练DUNE模型。

**Section sources**
- [neupan.py](file://neupan/neupan.py#L276-L327)
- [nrmp.py](file://neupan/blocks/nrmp.py#L224-L263)
- [initial_path.py](file://neupan/blocks/initial_path.py#L320-L361)

## 性能瓶颈诊断

利用内置的`time_print`功能可以定位性能瓶颈。

**诊断方法：**
1.  **启用时间打印**：在`planner.yaml`文件中，将`time_print`参数设置为`True`。
2.  **分析输出日志**：运行程序后，系统会打印出关键函数的执行时间，例如：
    -   `neupan forward`：整个规划器前向传播的总时间。
    -   `- nrmp forward`：NRMP层优化求解的时间。
    -   其他带有`@time_it`装饰器的函数执行时间。
3.  **定位瓶颈**：通过比较各部分的耗时，可以判断是NRMP求解、DUNE推理还是其他环节导致了整体延迟。

**Section sources**
- [util.py](file://neupan/util/__init__.py#L0-L43)
- [neupan.py](file://neupan/neupan.py#L130-L175)
- [nrmp.py](file://neupan/blocks/nrmp.py#L76-L114)

## 调试技巧

以下技巧有助于深入分析规划器的行为：

1.  **可视化轨迹**：
    -   使用`opt_trajectory`属性获取优化后的MPC轨迹。
    -   使用`ref_trajectory`属性获取参考轨迹（即初始路径的局部片段）。
    -   将两者进行可视化对比，可以清晰地看出规划器在多大程度上偏离了初始路径，以及偏离的原因（如避障）。

2.  **检查障碍物点**：
    -   使用`dune_points`获取经过DUNE网络处理后的障碍物点。
    -   使用`nrmp_points`获取最终输入到NRMP优化层的障碍物点。
    -   比较原始点云、DUNE输出点和NRMP输入点，可以验证DUNE网络是否正常工作。

3.  **动态调整参数**：
    -   利用`update_adjust_parameters`方法，可以在运行时动态调整`q_s`、`p_u`、`ro_obs`等权重参数，实时观察其对机器人行为的影响，从而快速找到最优配置。

**Section sources**
- [neupan.py](file://neupan/neupan.py#L368-L401)
- [neupan.py](file://neupan/neupan.py#L322-L374)