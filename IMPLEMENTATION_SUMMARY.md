# NeuPAN 方向性采样增强实现总结

## 🎯 核心创新点

### 1. **方向性采样策略（Directional Sampling Strategy）**

**问题背景：**
- 原始 NeuPAN 使用距离排序，导致只选择最近的障碍点
- 在走廊环境中，所有最近点都来自前方障碍，缺乏左/右方向信息
- 机器人无法判断应该向左还是向右转向

**解决方案：**
- 替代均匀采样的混合选择策略
- 在关键角度（±45°）进行密集采样，保证方向信息
- 结合最近点采样，保留精确避障能力

**实现细节：**
```
输入：100 个激光点（-90° 到 +90°，均匀分布）

采样策略：
  1. 左侧关键区域（-45° 附近）：索引 24, 25, 26, 27, 28（5个点）
  2. 右侧关键区域（+45° 附近）：索引 74, 75, 76, 77, 78（5个点）
  3. 最近点：从剩余点中按距离排序选取 5 个点

输出：15 个点（10 个方向点 + 5 个最近点）
```

---

### 2. **虚拟点填充机制（Virtual Point Filling）**

**问题背景：**
- 激光雷达在空旷方向无法检测到障碍物（返回 range_max）
- 这些方向被过滤掉，导致 NRMP 无法感知"这个方向很空旷"

**解决方案：**
- 不过滤无限远的点，而是填充为 10m 的虚拟点
- 虚拟点表示"该方向空旷，距离很远"
- NRMP 通过优化安全距离 d，自然倾向于选择虚拟点多的方向

**实现细节：**
```
激光雷达扫描处理：
  - 如果 scan_range < range_max：正常处理（真实障碍点）
  - 如果 scan_range >= range_max：创建虚拟点（距离 = 10m）

效果：
  - 空旷方向有点（10m 远）
  - 障碍方向有点（实际距离）
  - NRMP 看到的安全距离差异明显
```

---

## 📝 修改文件清单

### 1. `neupan/blocks/dune.py`

**修改内容：**
- 替换 `__init__` 参数：
  - 移除：`use_hybrid_selection`, `direction_sample_interval`
  - 新增：`use_directional_sampling`, `key_directions`
  
- 替换 `forward` 方法的采样逻辑（第 222-271 行）：
  - 新增方向性采样分支
  - 从关键方向提取点
  - 从剩余点中选择最近点
  - 拼接输出

**关键代码：**
```python
# 关键方向窗口计算
half_before = (window_size - 1) // 2
half_after = window_size - 1 - half_before
start_idx = max(0, center_idx - half_before)
end_idx = min(num_points, center_idx + half_after + 1)

# 例如：center_idx=25, window_size=5
# -> [24, 25, 26, 27, 28]
```

---

### 2. `neupan/blocks/pan.py`

**修改内容：**
- 替换配置读取逻辑（第 84-100 行）：
  - 移除：`hybrid_selection` 配置读取
  - 新增：`directional_sampling` 配置读取
  - 传递新参数给 DUNE

---

### 3. `neupan/neupan.py`

**修改内容：**
- `scan_to_point` 函数（第 498-525 行）：
  - 添加虚拟点填充逻辑
  - 无限远点填充为 10m
  
- `scan_to_point_velocity` 函数（第 583-602 行）：
  - 同样的虚拟点填充逻辑
  - 虚拟点速度设为 0

---

### 4. `example/corridor/diff/planner.yaml`

**修改内容：**
```yaml
pan:
  nrmp_max_num: 15  # 12 个方向点 + 5 个最近点 + 余量
  
  directional_sampling:
    enabled: true
    key_directions:
      - center_index: 25    # -45° 方向
        window_size: 5      # 5 个点
      - center_index: 75    # +45° 方向
        window_size: 5      # 5 个点
    nearest_num: 5          # 5 个最近点

adjust:
  d_max: 1.0  # 安全距离上限
  d_min: 0.2  # 安全距离下限
  eta: 10.0   # 安全距离权重
```

---

## 🎯 效果对比

### 原始算法（距离排序）
```
走廊场景：
  - 左墙：5m
  - 前方障碍：1m
  - 右墙：5m

输出点：10 个最近点
  - 全部来自前方障碍（1m 附近）
  - 缺乏左/右方向信息
  
结果：
  ❌ 机器人无法判断转向方向
  ❌ 可能撞向墙壁或陷入死胡同
```

### 新方案（方向性采样 + 虚拟点）
```
走廊场景：
  - 左墙：5m
  - 前方障碍：1m
  - 右墙：5m

输出点：15 个点
  - 左侧 -45°：5 个点（距离 ~5m）
  - 右侧 +45°：5 个点（距离 ~5m）
  - 最近点：5 个点（距离 ~1m）

NRMP 优化：
  - 左方向的 d 可达 5m
  - 右方向的 d 可达 5m
  - 前方的 d 只能达 1m
  
结果：
  ✅ 优化器明确看到左/右更空旷
  ✅ 自然选择向左或向右转向
  ✅ 成功避开前方障碍和走廊墙壁
```

---

## 🔧 配置参数说明

| 参数 | 含义 | 推荐值 | 说明 |
|------|------|--------|------|
| `center_index` | 关键角度的索引 | 25, 75 | 对应 -45°, +45° |
| `window_size` | 每个关键方向的点数 | 5 | 密集采样 |
| `nearest_num` | 最近点数量 | 5 | 精确避障 |
| `d_max` | 安全距离上限 | 1.0-5.0 | 越大越能区分方向 |
| `eta` | 安全距离权重 | 10-15 | 越大越强调避障 |

---

## ✅ 向后兼容性

- 通过 `directional_sampling.enabled: false` 可以禁用新功能
- 回退到原始的距离排序算法
- 不影响现有代码和配置

---

## 🚀 后续改进方向

1. **动态关键角度调整**
   - 根据环境自动调整 ±45° 为其他角度
   - 适应不同走廊宽度

2. **多层级采样**
   - 不同距离范围采用不同采样密度
   - 近处密集，远处稀疏

3. **学习式参数优化**
   - 通过强化学习自动调整 `center_index`, `window_size`
   - 适应不同场景

4. **可视化工具**
   - 显示采样点分布
   - 显示 NRMP 的安全距离 d 值
   - 便于调参和调试

